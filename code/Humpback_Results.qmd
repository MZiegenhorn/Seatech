---
title: "Humpback Data Analysis"
author: "Anne Simonis"
format: pdf
editor: visual
---

## Goals of this study

Investigate the co-occurrence of humpback whales and vessel noise.

## Data

Acoustic data was collected from drifting acoustic recorders during the 2018 California Current Ecosystem survey. See [Simonis et al 2020](https://repository.library.noaa.gov/view/noaa/27223) for more details. Data analyzed here includes CCES Drifts 10, 12, 13, 14, 16, 20.

## Combine Logs

The presence of humpback whales and ships were logged by 3 Seatech analysts, including Virginia Pearson, Audrey Bahnke, and Sarah Bahnke.

```{r}
#| echo: false
#| message: false
#| warning: false

# # # if (!require("pacman")) install.packages("pacman")
# if(!require('devtools')) install.packages('devtools')
# # install from GitHub
devtools::install_github('TaikiSan21/PAMmisc')
# devtools::install_github('ericpante/marmap')
suppressMessages(pacman::p_load(knitr,here,lubridate,dplyr,magrittr,xlsx,RSQLite,viridis,marmap,ggplot2,suncalc,ggnewscale,PAMmisc,stringr))

#Sarah's logs
LogSB<-list.files(here('data','2023','Humpback whales','SB'), pattern='.xls',full.names = TRUE) %>%
  lapply(read.xlsx,sheetName='Detections') %>%
  bind_rows %>%
  select(Input.file,Species.Code,Call,Start.time,End.time,Comments) %>%
  mutate(Analyst='SB')

#Virginia's logs
LogVP<-list.files(here('data','2023','Humpback whales','VP'), pattern='.xls',full.names = TRUE) %>%
  lapply(read.xlsx,sheetName='Detections') %>%
  bind_rows %>%
  select(Input.file,Species.Code,Call,Start.time,End.time,Comments)%>%
  mutate(Analyst='VP')

#Audrey's logs
LogAB<-list.files(here('data','2023','Humpback whales','AB'), pattern='.xls',full.names = TRUE) %>%
  lapply(read.xlsx,sheetName='Detections') %>%
  bind_rows %>%
  select(Input.file,Species.Code,Call,Start.time,End.time,Comments)%>%
  mutate(Analyst='AB')

Log<-rbind(LogSB,LogVP,LogAB)

#Save Humpback and Anthropogenic sounds and remove duplicates
Log <-Log %>%
  filter(Species.Code %in% c('Mn','Anthro')) %>%
  filter(Call %in% c("Ship/Other","Ship/Small Boat",
                     "Song","Non-Song","Unspecified",'All')) %>%
  distinct() 

#Rename Drifts with word 'Drift'
Log$Input.file<-str_replace(Log$Input.file,'Drift-','CCES_')
Log$Input.file<-str_replace(Log$Input.file,'Drift_','CCES_')

#Define Drift Number based on input file
Ind<-str_locate(Log$Input.file,'CCES_')
Log$Drift<-substr(Log$Input.file,Ind+5,Ind+7)
Log$Drift<-as.numeric(gsub('\\\\','',Log$Drift))

#Create UTC variable for start time
Log$UTC<-with_tz(Log$Start.time,tz="GMT")

#Omit events with missing end time 
Log<-Log[-is.na(Log$End.time),]

```

```{r}
#| echo: false
#| message: false
#| warning: false

drifts <- c(10,12,13,14,16,20)
Species<-c('Mn','Anthro')

#Create dataframe to save detections from all drifts
TimesAll<-data.frame()
GPSAll<-data.frame()

#Use PG databases for duty cycle times
#load database
sqlite <- dbDriver("SQLite")
dbfiles<-list.files(here('data','2023','CCES2018_Drifts','Beaked whales'),full.names=TRUE)

for(d in 1:length(drifts)){
  DriftID<-paste0('Drift-',drifts[d])
  conn <- dbConnect(sqlite,dbfiles[which(!is.na(str_match(dbfiles,DriftID)))])
  DF <- dbReadTable(conn, "Sound_Acquisition")    
  GPS<-dbReadTable(conn,"gpsData")
  dbDisconnect(conn)
  
  GPS<-GPS %>%
    select(UTC,Latitude,Longitude)%>%
    mutate(Drift=DriftID,UTC=as.POSIXct(GPS$UTC,'%Y-%m-%d %H:%M',tz='GMT'))
    
    GPSAll<-rbind(GPS,GPSAll)
  
  DF<-DF %>%
    mutate(Status=gsub(" ","",Status)) 
  
  StartUTC<-DF %>% 
    filter(Status=="Start") %>%
    mutate(Start = as.POSIXct(UTC,'%Y-%m-%d %H:%M:%OS',tz='GMT')) %>%
    select(Start) 
  
  StopUTC<-DF %>% 
    filter(Status=="Stop") %>%
    mutate(Stop = as.POSIXct(UTC,'%Y-%m-%d %H:%M:%OS',tz='GMT')) %>%
    select(Stop)  
  
  TimesDF<-data.frame(Start=StartUTC,Stop=StopUTC) %>%
    mutate(Drift = DriftID)
  
  TimesDF$Presence<-'Absent'
  TimesDF$Species<-'NA'
  
  #Loop through times to see if events span "recording on" periods               
  for(m in 1:nrow(Log)){
    IndStart<-max(which(TimesDF$Start<=Log$Start.time[m]))
    IndStop<-min(TimesDF$Stop>=Log$End.time[m])
    if(IndStart>0){
      if(is.na(IndStop) | IndStop==0){IndStop=IndStart}
      TimesDF$Presence[IndStart:IndStop]<-'Present'
      TimesDF$Species[IndStart:IndStop]<-rep(Log$Species.Code[m],length(IndStart:IndStop))
    }
  }              
  
  TimesDF<-TimesDF %>% 
    filter(Presence=="Present")%>%
    select(Start,Drift,Species) %>%
    rename(UTC=Start)

  TimesAll<-rbind(TimesDF,TimesAll)
}

```

## Plots

### Diel Plot

```{r}
#Define Figure Options
figtitle<-c('Drift-10','Drift-12','Drift-13','Drift-14','Drift-16','Drift-20')

MnColor = 'magenta'
ShipColor = 'orange'
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| 
PlotPresDrifts<-function(figtitle){
  SpDF<-TimesAll %>%
    filter(Drift==figtitle)
  
  MnDF<-(TimesAll) %>%
  filter(Drift==figtitle,Species=="Mn")
  
  AnthroDF<-(TimesAll) %>%
  filter(Drift==figtitle, Species=="Anthro")
  
  GPSDF<-(GPSAll) %>%
  filter(Drift==figtitle)
  
    plotPresGrid(SpDF,start=min(GPSDF$UTC),end=max(GPSDF$UTC),type="presence",by=Species,timeBin="minute",gps=GPSDF,title=paste0(figtitle,': Humpback whales'))
  
  plotPresGrid(MnDF,start=min(GPSDF$UTC),end=max(GPSDF$UTC),type="presence",timeBin="minute",gps=GPSDF,title=paste0(figtitle,': Humpback whales'))
  
  plotPresGrid(AnthroDF,start=min(GPSDF$UTC),end=max(GPSDF$UTC),type="presence",timeBin="minute",gps=GPSDF,title=paste0(figtitle,': Ships'))
  
  
}

lapply(figtitle,PlotPresDrifts)

```

### **Weekly Plot**

```{r}
#| echo: false
#| message: false
#| warning: false

PlotPresBars<-function(figtitle){
  SpDF<-(TimesAll) %>%
  filter(Drift==figtitle)
  
  GPSDF<-(GPSAll) %>%
  filter(Drift==figtitle)
  
  plotPresBar(SpDF,start=min(GPSDF$UTC),end=max(GPSDF$UTC),timeBin="day",by="Species",title=paste0(figtitle,': Humpback whales and ships'),fill=Species)+
    scale_fill_manual(values=c(MnColor, ShipColor))
}

lapply(figtitle,PlotPresBars)

```

### Map

```{r}
#| echo: false
#| message: false
#| warning: false
#Function PlotPresMaps will map events on each drift 
PlotPresMaps<-function(figtitle){
  MnDF<-(TimesAll) %>%
    filter(Drift==figtitle, Species=="Mn")
  
  AnthroDF<-(TimesAll) %>%
    filter(Drift==figtitle, Species=="Anthro")
  
  GPSDF<-(GPSAll) %>%
    filter(Drift==figtitle)
  
  #Define position of each event
  for(c in 1:nrow(MnDF)){
    Ind<-which.min(abs(as.numeric(difftime(GPSDF$UTC,MnDF$UTC[c],units="mins"))))
    MnDF$Longitude[c]<-GPSDF$Longitude[Ind]
    MnDF$Latitude[c]<-GPSDF$Latitude[Ind]
  }
    for(c in 1:nrow(AnthroDF)){
    Ind<-which.min(abs(as.numeric(difftime(GPSDF$UTC,AnthroDF$UTC[c],units="mins"))))
    AnthroDF$Longitude[c]<-GPSDF$Longitude[Ind]
    AnthroDF$Latitude[c]<-GPSDF$Latitude[Ind]
  }
  
  SpDF<-rbind(MnDF,AnthroDF)

  #define boundaries of the map
  lon1<-min(GPSDF$Longitude)-2
  lon2<-max(GPSDF$Longitude)+2
  lat1<-max(GPSDF$Latitude)+2
  lat2<-min(GPSDF$Latitude)-2

  #Extract bathymetry data from NOAA (saves local file to speed future performance)
  bat<-getNOAA.bathy(lon1,lon2,lat1,lat2,resolution=1,keep=TRUE)

  autoplot.bathy(bat,geom=c('r'),coast=TRUE)+
    coord_cartesian(expand = 0)+
    geom_contour(aes(z=z),breaks=c(-100,-500,-1000),color="gray24")+
    scale_fill_gradientn(values = scales::rescale(c(min(bat), -120, 0, max(bat))),
                         colors = c("midnightblue", "royalblue3", "grey50", "grey80"),name="Depth (m)")+
    geom_point(data=GPSDF,aes(Longitude,Latitude),size=0.1)+
    new_scale_color()+
    geom_point(data=SpDF,aes(x=Longitude,y=Latitude,color=Species))+
scale_color_manual(values=c(MnColor, ShipColor), labels=c("Humpback whales", "Ships"),name="")+
    xlab('Longitude')+ylab('Latitude')+ggtitle(figtitle)

}

lapply(figtitle,PlotPresMaps)

```

#### Map of all drifts

```{r}
#| echo: false
#| message: false
#| warning: false
#| fig-width: 4
#| fig-height: 6
#| fig-cap: Map of all drifts analyzed


#Create dataframe with positions of all events
SpDF_gps<-data.frame()

for(d in 1:length(figtitle)){
    MnDF<-(TimesAll) %>%
    filter(Drift==figtitle[d],Species=="Mn")
  
   AnthroDF<-(TimesAll) %>%
    filter(Drift==figtitle[d],Species=="Anthro")
  
  GPSDF<-(GPSAll) %>%
    filter(Drift==figtitle[d])

  #Define position of each event
  for(c in 1:nrow(MnDF)){
    Ind<-which.min(abs(as.numeric(difftime(GPSDF$UTC,MnDF$UTC[c],units="mins"))))
    MnDF$Longitude[c]<-GPSDF$Longitude[Ind]
    MnDF$Latitude[c]<-GPSDF$Latitude[Ind]
  }
  
   for(c in 1:nrow(AnthroDF)){
    Ind<-which.min(abs(as.numeric(difftime(GPSDF$UTC,AnthroDF$UTC[c],units="mins"))))
    AnthroDF$Longitude[c]<-GPSDF$Longitude[Ind]
    AnthroDF$Latitude[c]<-GPSDF$Latitude[Ind]
  }
  
  DF<-rbind(MnDF,AnthroDF)
  
SpDF_gps<-rbind(DF,SpDF_gps)
DF<-data.frame()
MnDF<-data.frame()
AnthroDF<-data.frame()
}

#define boundaries of the map
lon1=-132;lon2=-114;lat1=27;lat2=50

#Extract bathymetry data from NOAA (saves local file to speed future performance)
bat<-getNOAA.bathy(lon1,lon2,lat1,lat2,resolution=1,keep=TRUE)

autoplot.bathy(bat,geom=c('r'),coast=TRUE)+
  coord_cartesian(expand = 0)+
  geom_contour(aes(z=z),breaks=c(-1000),color="gray24")+
  scale_fill_gradientn(values = scales::rescale(c(min(bat), -120, 0, max(bat))),
                       colors = c("midnightblue", "royalblue3", "grey50", "grey80"),name="Depth (m)")+
  geom_point(data=GPSAll,aes(Longitude,Latitude),size=0.1)+
  new_scale_color()+
  geom_point(data=SpDF_gps,aes(x=Longitude,y=Latitude,color=Species))+
  scale_color_manual(values=c(MnColor,ShipColor), labels=c("Humpback whales","Ships"),name="")+
  xlab('Longitude')+ylab('Latitude')+ggtitle('All Drifts')

```
